---
title: "Arduino Uno R4 WiFi を試してみる"
emoji: "🕌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Arduino","C"]
published: false
---

# はじめに
[木更津高専アドベントカレンダー](https://qiita.com/advent-calendar/2023/nit_kisarazu)14日目担当のこかすた〜です。  
今日は、先月技適を取得し国内販売が始まったArduino UNO R4 WiFiで遊びます。Arduinoは過去に学校の授業で使用しただけで、個人で購入・使用するのは初めてです。

# Arduino UNO R4 WiFiについて
今回使用するのは、Arduino UNOシリーズの最新機である、Arduino UNO R4 WiFiです。僕は11月の上旬に[SWITCH SCIENCE](https://www.switch-science.com/products/9090)で購入しました。￥4950です。  
過去のUNOシリーズと比べて、R4 WiFiには以下の特徴があります。
 - ESP32-S3ワイヤレスモジュールを搭載し、802.11 b/g/nに対応するようになった
 - ボード上にマトリックスパネルが搭載された(色は赤色のみ)
 - 接続がUSB-Cになった
 - 入力電圧が24Vまで対応に
 - マイコンがルネサス製に
 - メモリやクロックが強化され処理性能が向上

注文したら、1週間ほどで届きました。こんな感じの箱の中に本体が入ってました。(届いたときは、この箱が更に配送用の箱に入ってました)
![](/images/arduino_R4wifi/arduino_box.jpg)

全体はこんな感じになってます。  
ボードの右下にある白い長方形のエリアがマトリックスパネルとなっています。　　
また、左下の方にある銀色のチップがESP32-S3です。ここでワイヤレス通信を行います。
![](/images/arduino_R4wifi/arduino.jpg)

側面を見ると、USB-Cになってるのがわかると思います。
![](/images/arduino_R4wifi/arduino_port.jpg)

# 起動してみる
USBケーブルをPCとArduinoにそれぞれつなげると、勝手に起動します。  
最初はGoogle Pixel4a購入時に付属してきたUSBケーブルで接続しようとしたのですが、うまく行かなかったのでAtoCケーブルにつないだらうまく行きました。

ちょっと画質が荒いですが、工場出荷状態で起動すると以下のようにマトリックスパネルに表示されます。  
https://youtu.be/FTTSpupEba0

# はじめに環境構築
前提として、僕は以下の環境を使用しています。だいぶ特殊な環境なのであまり参考にならないかもしれないです。
> ASUS TUF GAMING A15  
> OS : Arch Linux  
> WM : i3wm

まずは、Arduino IDEをAURからインストールします。今回は2.x系にしてみます。
> yay -S arduino-ide-bin

インストールが終わったらarduino-ideを起動し、ArduinoをPCと接続してIDE上部から「Arduino UNO R4 WiFi」を選択します。すると、ドライバ的なやつを入れるかどうかを右下で聞かれるので、Yesを押して待ちます。  
ArduinoIDEはこんな感じです。
![](/images/arduino_R4wifi/arduino_ide.png)
学校で使用しているのは1.x系ですが、左側にサイドバーができていたりなど、割と違う箇所があるなというふうに思いました。  
ただし、これだけではまだ使えません。IDE自体は使えるのですが、Arduinoに書き込みを行うときにエラーが発生してしまいます。そこで、
> sudo chmod a+rw /dev/ttyACM0

を実行します。環境によっては`/dev/`以降が異なるかもしれないので、その場合は適宜書き換えてください。これで書き込みができるようになったので、環境構築も完了です。

# LEDマトリックスパネルの制御
Arduinoで最初にやることと言ったらLチカ... はもう過去の話です。Arduinoは新時代に突入しました。せっかくマトリックスパネルがあるので、それを制御してみましょう。  

## 表示するものを作成する
公式から[LED MATRIX EDITOR](https://ledmatrix-editor.arduino.cc/)というツールが提供されていますので、今回はそこで絵を書いて表示させてみます。
僕はこのような絵を書きました。どこか既視感のある鳥です。
![](/images/arduino_R4wifi/bard.png)

その後、右上のコードボタンを押して名前をつけてOKを押すと、データがダウンロードされます。先程の鳥の場合は以下のようになりました。
```c
const uint32_t animation[][4] = {
	{
		0x41c63e7f,
		0xc3fc7fc3,
		0xf81f03c0,
		66
	}
};
```
これがマトリックスパネルのデータとなります。これをプログラムに組み込むことで、鳥を表示させます。

## 表示するプログラムを作成する
`Arduino_LED_Matrix.h`をincludeすることで、マトリックスパネルの制御を簡単に制御できます。
> もしも`arduino_led_matrix.h: そのようなファイルやディレクトリはありません`となる場合は、 「ツール」→「ボード:(何かしらのボード名)」→ 「Arduino Renesas UNO R4 Boards」→「Arduino UNO R4 WiFi」を選択することで解決できます。

その上で、ダウンロードしてきた配列の0番目を`matrix.loadFrame`することで、表示させることができます。  
アニメーションを作成することもできますが、これはまた後で触れます。
```c
#include "Arduino_LED_Matrix.h"

ArduinoLEDMatrix matrix;

void setup() {
  Serial.begin(115200);
  matrix.begin();
}

//ここにはダウンロードしてきた配列の宣言を貼り付ける
const uint32_t animation[][4] = {
  {
    0x41c63e7f,
    0xc3fc7fc3,
    0xf81f03c0,
    66
  }
};

void loop(){
    matrix.loadFrame(animation[0]);
}
```

そして、左上のチェックマークからコンパイルし、その隣の書き込みボタンを押すと書き込みができます。
![](/images/arduino_R4wifi/arduino_bard.jpg)
色が我々のよく知る「アレ」と違いますが、残念ながら赤色のみとなっています。

# マトリックスパネルでアニメーション
次は、アニメーションを流してみます。  
原理は特に難しいものではなく、先程のように書いた画像を連続で再生するだけです。これも公式が[先程のツール](https://ledmatrix-editor.arduino.cc/)で対応しているので、それを使ってみます。

## 表示するものを作成する
とりあえず正弦波でも流してみましょう。まぁ、正弦波をきれいにかけるほどドットは多くないんですけども... 
画面下のプラスボタンを押すことでコマを追加することができます。
![](/images/arduino_R4wifi/drawSineCurve.jpg)
エディタ中央上部にある再生ボタンを押すことでアニメーションのプレビューもできます。
そして、先程同様コードをダウンロードします。
```c
const uint32_t animation[][4] = {
	{
		0x20050,
		0x18820440,
		0x28010000,
		66
	},
	{
		0x10028,
		0x4418220,
		0x14008000,
		66
	},
	{
		0x8014,
		0x2204118,
		0xa004000,
		66
	},
	{
		0x400a,
		0x1102084,
		0x5802000,
		66
	},
	{
		0x2005,
		0x88104a,
		0x2401000,
		66
	},
	{
		0x1002,
		0x80448825,
		0x1200000,
		66
	},
	{
		0x801,
		0x48224412,
		0x80100000,
		66
	},
	{
		0x480,
		0xa4112201,
		0x40080000,
		66
	},
	{
		0x80240,
		0x52081100,
		0xa0040000,
		66
	},
	{
		0x401a0,
		0x21040880,
		0x50020000,
		66
	}
};
```
こいつは、配列1つあたりが1コマを表しています。
1コマのデータには、0~2に表示するデータが16進数で入り、3にはフレームの表示時間がmsで記録されています。  
フレームの表示時間はエディタ下部にあるフレーム一覧のところに数字があるので、そこから編集が可能です。あとは直接いじるのも手です。

## 表示するプログラムを作成する
先程のコード似てますが少しだけ違います。
```c
#include "Arduino_LED_Matrix.h"

//アニメーションのコマ数。
#define SIZ 10

ArduinoLEDMatrix matrix;

void setup() {
  Serial.begin(115200);
  matrix.begin();
}

//アニメーションのデータをここで宣言する。長いので省略。
const uint32_t animation[][4]; 


void loop(){
  for(int i=0;i<SIZ;i++){
    matrix.loadFrame(animation[i]); //アニメーションデータのうちi番目を表示
    delay(animation[i][3]); //アニメーションデータのi番目から待機時間を読み取り待機
  }
}
```
フレームの長さを記録する定数を用意しておき、配列の戦闘から順にfor文で表示→待機　をループさせます。これによりアニメーションが表示できます。  
書き込んで見ると、以下のように正弦波(というよりジグザグ?)が表示されました。
https://youtu.be/rDUVonvl-as

# 同一LAN内からマトリックスパネルの鳥を制御する
さて、マトリックスパネルを使って遊んだので、次は製品名にもなっている目玉機能である、WiFiを使ってみます。  
公式が[様々なサンプルプログラムを公開](https://docs.arduino.cc/tutorials/uno-r4-wifi/wifi-examples)してくれているので、それを改造して「簡易Webサーバーを立ち上げ、そこから鳥のロゴのON/OFFを行う」プログラムにしてみたいと思います。

## Webサーバーを立ち上げてみる
まずは、サンプルプログラムをそのまま用いてみます。前提として、SSIDとパスワードを記載した`arduino_secrets.h`を同一ディレクトリに置く必要があります。
```c
//arduino_secrets.h header file
#define SECRET_SSID "yournetwork"
#define SECRET_PASS "yourpassword"
```
別ファイルに記述したほうが、間違ってGitHubにプッシュしてしまうなどの事故も防ぎやすいです。

用意したら、次はメインファイルに[サンプルコード](https://github.com/arduino/ArduinoCore-renesas/blob/main/libraries/WiFiS3/examples/SimpleWebServerWiFi/SimpleWebServerWiFi.ino)をそのままコピーして、コンパイル→書き込みを行います。IDE上部の「ツール」→「シリアルモニタ」を使うことで、Arduinoの現在の状態を確認できます。  
しばらくすると`http://192.168.179.30/`に接続するようシリアルモニタに表示されるので、Arduinoと同じネットワーク内にある機器からアクセスすると、画像のようなサイトが開くと思います。
![](/images/arduino_R4wifi/webserver.webp)
ここでhereをクリックすると、それに合わせてArduino上のLEDが光ったり消えたりします。すごい。

## 鳥の表示をON/OFFできるように改造してみる
では、ここからはこれを改造して、鳥の表示をON/OFFできるようにします。  
まずは、ライブラリのインクルードと、鳥の表示されている状態とされていない状態の2つを格納した配列の宣言、それにmatrix変数の宣言を行います。
```c
#include "Arduino_LED_Matrix.h"

//中略(もとからあったプログラムが間にあるため)

ArduinoLEDMatrix matrix;
const uint32_t animation[][4] = {
	{
		0x41c63e7f,
		0xc3fc7fc3,
		0xf81f03c0,
		66
	},
  {
		0x00000000,
		0x00000000,
		0x00000000,
		66
	}
};
```
また、setup関数内ではマトリックスパネルを初期化するために以下を追加します。
```c
matrix.begin();
```
これで、マトリックスパネルの処理を変更できました。続けてWebサイトとその処理に手を加えていきます。
まずは、表示を変えます。「Click here to view/hide the bird logo」に変えてみました。
```c
// the content of the HTTP response follows the header:
client.print("<p style=\"font-size:7vw;\">Click <a href=\"/H\">here</a> to view the bird logo<br></p>");
client.print("<p style=\"font-size:7vw;\">Click <a href=\"/L\">here</a> to hide the bird logo<br></p>");
```
更にその下には、クリックしたときの動作が記述されています。Hのときに見せて、Lのときに隠すので、以下のように`matrix.loadFrame()`を追加してみました。
```c
// Check to see if the client request was "GET /H" or "GET /L":
if (currentLine.endsWith("GET /H")) {
  digitalWrite(LED_BUILTIN, HIGH);               // GET /H turns the LED on
  matrix.loadFrame(animation[0]);
}
if (currentLine.endsWith("GET /L")) {
  digitalWrite(LED_BUILTIN, LOW);                // GET /L turns the LED off
  matrix.loadFrame(animation[1]);
}
```
これで完成です。完全版のソースコードは[ここ](https://github.com/starkoka/Arduino-test/blob/main/birdONOFF.ino)にあります。
後は先程同様に書き込みを行い、同一LAN内から`http://192.168.179.30/`にアクセスすると、Webサイトが表示されました。
https://youtu.be/R_NosD4q59I
画面下の方においてあるArduinoのマトリックスパネルの表示が切り替わっていることが確認できると思います。

# 同一LAN内からマトリックスパネルに文字を表示する
最後に、文字を表示させてみたいと思います。Google先生に聞いたところ、[このブログ](https://nomolk.hatenablog.com/entry/2023/11/02/120000)を見つけたので、このブログの「日本語を出す」の章を参考に文字表示システムを構築、その後今はリンクのクリックのところをテキスト受信に変更していきます。

## 文字表示システムの構築
まずは、文字の表示です。先程鳥を表示していましたが、その代わりに文字を表示できるようにしてみます。  
ブログのとおりに導入を進めます。Arduinoのライブラリフォルダ`~/.arduino15/libraries/`にあったので、そこにmisakiUTF16を入れました。
その後、

# 参考文献
以下の記事を参考にさせていただきました。ありがとうございます。
 - [UNO R4 WiFi Network Examples | Arduino Documentation](https://docs.arduino.cc/tutorials/uno-r4-wifi/wifi-examples)
 - [Arduino Uno R4 WifiのLEDディスプレイに日本語やドット絵アニメーションを流す - nomolkのブログ](https://nomolk.hatenablog.com/entry/2023/11/02/120000)